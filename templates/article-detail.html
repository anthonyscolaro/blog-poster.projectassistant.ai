{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-file-text"></i> Article Preview</h2>
            <div>
                <button class="btn btn-outline-secondary" onclick="window.history.back()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                {% if article.status != 'In Progress' %}
                <a href="/pipeline" class="btn btn-primary">
                    <i class="bi bi-diagram-3"></i> Pipeline Monitor
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Article Info Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Article Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Content Details</h6>
                        <p><strong>Title:</strong> {{ article.title or 'Untitled' }}</p>
                        <p><strong>Slug:</strong> {{ article.slug or 'Not set' }}</p>
                        <p><strong>Primary Keyword:</strong> {{ article.primary_keyword or 'Not specified' }}</p>
                        {% if article.word_count %}
                        <p><strong>Word Count:</strong> {{ article.word_count }} words</p>
                        {% endif %}
                        {% if article.seo_score %}
                        <p><strong>SEO Score:</strong> 
                            <span class="badge {% if article.seo_score >= 80 %}bg-success{% elif article.seo_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ article.seo_score }}/100
                            </span>
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">SEO Metadata</h6>
                        <p><strong>Meta Title:</strong><br>
                           <small class="text-muted">{{ article.meta_title or 'Not set' }}</small>
                        </p>
                        <p><strong>Meta Description:</strong><br>
                           <small class="text-muted">{{ article.meta_description or 'Not set' }}</small>
                        </p>
                        <p><strong>Status:</strong> 
                            <span class="badge {% if article.status == 'In Progress' %}bg-warning{% else %}bg-success{% endif %}">
                                {{ article.status or 'Draft' }}
                            </span>
                        </p>
                        <p><strong>Created:</strong> {{ article.created_at.strftime('%Y-%m-%d %H:%M:%S') if article.created_at else 'Unknown' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Article Content -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> Article Content
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard()">
                            <i class="bi bi-clipboard"></i> Copy Markdown
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="togglePreview()">
                            <i class="bi bi-eye" id="previewIcon"></i> <span id="previewText">Preview</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Markdown Content -->
                <div id="markdownContent" style="display: block;">
                    <pre><code class="language-markdown">{{ article.content_markdown or article.markdown or 'No content available' }}</code></pre>
                </div>
                
                <!-- HTML Preview -->
                <div id="htmlPreview" style="display: none;">
                    {% if article.content_markdown or article.markdown %}
                        <div class="article-preview">
                            {{ (article.content_markdown or article.markdown) | markdown | safe }}
                        </div>
                    {% else %}
                        <div class="text-muted text-center py-5">
                            <i class="bi bi-file-x fs-1"></i>
                            <h4 class="mt-3">No Content Available</h4>
                            <p>This article doesn't have any content to display.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
{% if article.status != 'In Progress' %}
<div class="row mt-4">
    <div class="col-md-12 text-center">
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary" onclick="editArticle()">
                <i class="bi bi-pencil-square"></i> Edit Article
            </button>
            <button class="btn btn-outline-success" onclick="publishArticle()">
                <i class="bi bi-wordpress"></i> Publish to WordPress
            </button>
            <button class="btn btn-outline-warning" onclick="regenerateArticle()">
                <i class="bi bi-arrow-clockwise"></i> Regenerate
            </button>
            <button class="btn btn-outline-danger" onclick="deleteArticle()">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.pipeline-steps .step {
    display: flex;
    align-items: center;
    padding: 0.25rem 0;
    font-size: 0.875rem;
}

.pipeline-steps .step i {
    margin-right: 0.5rem;
    width: 1rem;
}

.progress-bar span {
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
}

#progressModal .modal-body {
    padding: 1.5rem;
}

#progressModal .pipeline-steps {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    border-left: 4px solid #0d6efd;
}
</style>
<script>
let isPreviewMode = false;
const currentArticleId = window.location.pathname.split('/articles/')[1];

function togglePreview() {
    const markdownContent = document.getElementById('markdownContent');
    const htmlPreview = document.getElementById('htmlPreview');
    const previewIcon = document.getElementById('previewIcon');
    const previewText = document.getElementById('previewText');
    
    if (isPreviewMode) {
        // Show markdown
        markdownContent.style.display = 'block';
        htmlPreview.style.display = 'none';
        previewIcon.className = 'bi bi-eye';
        previewText.textContent = 'Preview';
        isPreviewMode = false;
    } else {
        // Show HTML preview
        markdownContent.style.display = 'none';
        htmlPreview.style.display = 'block';
        previewIcon.className = 'bi bi-code';
        previewText.textContent = 'Markdown';
        isPreviewMode = true;
    }
}

function copyToClipboard() {
    const markdownText = document.querySelector('#markdownContent code').textContent;
    navigator.clipboard.writeText(markdownText).then(() => {
        showSuccessToast('Markdown copied to clipboard!');
    }).catch(err => {
        showErrorToast('Failed to copy to clipboard');
    });
}

function editArticle() {
    showInfoToast('Edit functionality coming soon!');
}

async function publishArticle() {
    const publishBtn = document.querySelector('button[onclick="publishArticle()"]');
    const originalText = publishBtn.innerHTML;
    
    try {
        // Show loading state
        publishBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Publishing...';
        publishBtn.disabled = true;
        
        // Get article data
        const title = `{{ article.title | replace("'", "\\'") }}`;
        const content = `{{ article.content_markdown | replace("'", "\\'") | replace("\n", "\\n") }}`;
        const slug = "{{ article.slug }}";
        const metaTitle = `{{ article.meta_title | replace("'", "\\'") }}`;
        const metaDescription = `{{ article.meta_description | replace("'", "\\'") }}`;
        
        // Build query parameters
        const queryParams = new URLSearchParams({
            title: title,
            content: content,
            status: "draft",
            slug: slug,
            category_name: "{{ article.category }}",
            meta_title: metaTitle,
            meta_description: metaDescription
        });
        
        const response = await fetch(`/publish/wp?${queryParams}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                categories: [],
                tags: []
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessToast(`Article published successfully! <a href="${result.edit_link}" target="_blank" class="text-white">Edit in WordPress</a>`);
        } else {
            showErrorToast('Publish failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        showErrorToast('Publish error: ' + error.message);
    } finally {
        // Reset button
        publishBtn.innerHTML = originalText;
        publishBtn.disabled = false;
    }
}

async function regenerateArticle() {
    // Confirm regeneration
    if (!confirm('Are you sure you want to regenerate this article? This will create a new version with the same topic.')) {
        return;
    }
    
    const regenBtn = document.querySelector('button[onclick="regenerateArticle()"]');
    const originalText = regenBtn.innerHTML;
    
    // Create progress modal
    showRegenerationProgress();
    
    try {
        // Show loading state on button
        regenBtn.innerHTML = '<i class="bi bi-hourglass-split spin"></i> Regenerating...';
        regenBtn.disabled = true;
        
        // Update progress
        updateProgress('Initializing pipeline...', 10);
        
        // Use the pipeline system to regenerate
        const primaryKeyword = "{{ article.primary_keyword }}";
        const secondaryKeywords = {{ article.secondary_keywords | tojson }};
        const title = "{{ article.title }}";
        
        // Create a proper pipeline config
        const pipelineConfig = {
            topic: title,
            primary_keyword: primaryKeyword,
            secondary_keywords: secondaryKeywords || [],
            enable_competitor_monitoring: true,
            enable_topic_analysis: true,
            enable_article_generation: true,
            enable_fact_checking: true,
            enable_wordpress_publishing: false, // Don't auto-publish regenerated articles
            min_words: 1500,
            max_words: 2500
        };
        
        // Update progress
        updateProgress('Sending regeneration request...', 20);
        
        const response = await fetch('/pipeline/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(pipelineConfig)
        });
        
        const result = await response.json();
        
        if (result.status === 'completed' && result.pipeline_id) {
            updateProgress('Article regenerated successfully!', 100);
            setTimeout(() => {
                hideProgressModal();
                showSuccessToast('Article regenerated successfully! Redirecting to new article...');
                setTimeout(() => {
                    window.location.href = `/pipeline/${result.pipeline_id}/view`;
                }, 1000);
            }, 1000);
        } else if (result.pipeline_id) {
            // Start polling for progress
            updateProgress('Pipeline started, monitoring progress...', 30);
            monitorPipelineProgress(result.pipeline_id);
        } else if (result.detail) {
            hideProgressModal();
            showErrorToast('Regeneration failed: ' + result.detail);
        } else {
            hideProgressModal();
            showErrorToast('Regeneration failed: ' + (result.errors ? result.errors.join(', ') : 'Unknown error'));
        }
    } catch (error) {
        hideProgressModal();
        showErrorToast('Regeneration error: ' + error.message);
    } finally {
        // Reset button if still on page
        if (regenBtn) {
            regenBtn.innerHTML = originalText;
            regenBtn.disabled = false;
        }
    }
}

// Progress monitoring functions
function showRegenerationProgress() {
    const modalHtml = `
        <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-arrow-clockwise spin"></i> Regenerating Article
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="progressBar" role="progressbar" style="width: 0%">
                                    <span id="progressPercent">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div id="progressStatus" class="fw-bold mb-2">Starting regeneration...</div>
                            <div id="progressDetails" class="text-muted small">This may take 1-3 minutes</div>
                        </div>
                        <div class="mt-3">
                            <div class="pipeline-steps">
                                <div class="step" id="step-init">
                                    <i class="bi bi-circle text-muted"></i> Initialize Pipeline
                                </div>
                                <div class="step" id="step-competitor">
                                    <i class="bi bi-circle text-muted"></i> Competitor Analysis
                                </div>
                                <div class="step" id="step-topic">
                                    <i class="bi bi-circle text-muted"></i> Topic Analysis
                                </div>
                                <div class="step" id="step-generate">
                                    <i class="bi bi-circle text-muted"></i> Article Generation
                                </div>
                                <div class="step" id="step-fact-check">
                                    <i class="bi bi-circle text-muted"></i> Fact Checking
                                </div>
                                <div class="step" id="step-complete">
                                    <i class="bi bi-circle text-muted"></i> Complete
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelRegeneration()" id="cancelBtn">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
}

function updateProgress(status, percent, stepId = null) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
        progressPercent.textContent = percent + '%';
        progressStatus.textContent = status;
        
        // Update step indicators
        if (stepId) {
            const step = document.getElementById('step-' + stepId);
            if (step) {
                const icon = step.querySelector('i');
                icon.className = 'bi bi-check-circle-fill text-success';
            }
        }
        
        // Auto-update step indicators based on progress
        const steps = [
            {id: 'init', threshold: 10},
            {id: 'competitor', threshold: 25},
            {id: 'topic', threshold: 40},
            {id: 'generate', threshold: 70},
            {id: 'fact-check', threshold: 90},
            {id: 'complete', threshold: 100}
        ];
        
        steps.forEach(step => {
            if (percent >= step.threshold) {
                const stepEl = document.getElementById('step-' + step.id);
                if (stepEl) {
                    const icon = stepEl.querySelector('i');
                    if (percent === step.threshold) {
                        icon.className = 'bi bi-arrow-clockwise spin text-primary';
                    } else if (percent > step.threshold) {
                        icon.className = 'bi bi-check-circle-fill text-success';
                    }
                }
            }
        });
    }
}

function hideProgressModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    if (modal) {
        modal.hide();
        setTimeout(() => {
            const modalEl = document.getElementById('progressModal');
            if (modalEl) {
                modalEl.remove();
            }
        }, 300);
    }
}

function cancelRegeneration() {
    if (confirm('Are you sure you want to cancel the regeneration?')) {
        hideProgressModal();
        const regenBtn = document.querySelector('button[onclick="regenerateArticle()"]');
        if (regenBtn) {
            regenBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Regenerate';
            regenBtn.disabled = false;
        }
    }
}

async function monitorPipelineProgress(pipelineId) {
    const maxAttempts = 60; // 5 minutes max (5-second intervals)
    let attempts = 0;
    
    const checkProgress = async () => {
        try {
            const response = await fetch(`/pipeline/${pipelineId}/details`);
            const details = await response.json();
            
            if (details.status === 'completed') {
                updateProgress('Article regenerated successfully!', 100);
                setTimeout(() => {
                    hideProgressModal();
                    showSuccessToast('Article regenerated successfully! Redirecting to new article...');
                    setTimeout(() => {
                        window.location.href = `/pipeline/${pipelineId}/view`;
                    }, 1000);
                }, 1000);
                return;
            } else if (details.status === 'failed') {
                hideProgressModal();
                showErrorToast('Regeneration failed: ' + (details.errors ? details.errors.join(', ') : 'Pipeline failed'));
                return;
            }
            
            // Update progress based on pipeline status
            const progressMap = {
                'competitor_monitoring': {percent: 25, status: 'Analyzing competitors...'},
                'topic_analysis': {percent: 40, status: 'Analyzing topics...'},
                'article_generation': {percent: 70, status: 'Generating article...'},
                'fact_checking': {percent: 90, status: 'Fact checking...'},
                'wordpress_publishing': {percent: 95, status: 'Finalizing...'}
            };
            
            // Try to determine current step (simplified)
            let currentProgress = 30; // Default if unknown
            let currentStatus = 'Processing...';
            
            // Use execution time as rough progress indicator
            if (details.execution_time) {
                const elapsed = details.execution_time;
                if (elapsed < 30) currentProgress = 40;
                else if (elapsed < 60) currentProgress = 60;
                else if (elapsed < 120) currentProgress = 80;
                else currentProgress = 90;
            }
            
            updateProgress(currentStatus, currentProgress);
            
            attempts++;
            if (attempts < maxAttempts) {
                setTimeout(checkProgress, 5000); // Check every 5 seconds
            } else {
                hideProgressModal();
                showErrorToast('Progress monitoring timed out. Check the pipeline monitor for status.');
            }
            
        } catch (error) {
            console.error('Error monitoring progress:', error);
            attempts++;
            if (attempts < maxAttempts) {
                setTimeout(checkProgress, 5000);
            } else {
                hideProgressModal();
                showErrorToast('Unable to monitor progress. Check the pipeline monitor for status.');
            }
        }
    };
    
    setTimeout(checkProgress, 2000); // Start checking after 2 seconds
}

async function deleteArticle() {
    // Confirm deletion
    if (!confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
        return;
    }
    
    const deleteBtn = document.querySelector('button[onclick="deleteArticle()"]');
    const originalText = deleteBtn.innerHTML;
    
    try {
        // Show loading state
        deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
        deleteBtn.disabled = true;
        
        const response = await fetch(`/api/articles/${currentArticleId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccessToast('Article deleted successfully!');
            // Redirect back to articles list after a brief delay
            setTimeout(() => {
                window.location.href = '/articles';
            }, 2000);
        } else {
            const result = await response.json();
            showErrorToast('Delete failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        showErrorToast('Delete error: ' + error.message);
    } finally {
        // Reset button if still on page
        if (deleteBtn) {
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    }
}

// Toast notification functions
function showSuccessToast(message) {
    showToast(message, 'success', 'bi-check-circle-fill');
}

function showErrorToast(message) {
    showToast(message, 'danger', 'bi-x-circle-fill');
}

function showInfoToast(message) {
    showToast(message, 'info', 'bi-info-circle-fill');
}

function showToast(message, type = 'info', icon = 'bi-info-circle') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="${icon} me-2"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast to container
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    toastContainer.appendChild(toastElement.firstElementChild);
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastContainer.lastElementChild);
    toast.show();
    
    // Remove after hidden
    toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}
</script>
{% endblock %}