{% extends "base.html" %}

{% block page_title %}Configuration Profiles{% endblock %}

{% block styles %}
<style>
    /* Make modal more stable and prevent accidental closes */
    .modal-dialog {
        pointer-events: none;
    }
    .modal-content {
        pointer-events: auto;
    }
    
    /* Ensure modal backdrop is properly positioned */
    .modal-backdrop {
        z-index: 1040 !important;
    }
    .modal {
        z-index: 1050 !important;
    }
    
    /* Prevent modal from closing on form element interactions */
    .modal-body input,
    .modal-body select,
    .modal-body textarea,
    .modal-body button {
        pointer-events: auto !important;
    }
    
    /* Make sure the modal stays centered */
    .modal-dialog-centered {
        min-height: calc(100% - 1rem);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-gear"></i> Configuration Profiles</h2>
            <div>
                <button class="btn btn-success" onclick="showCreateModal()">
                    <i class="bi bi-plus-circle"></i> New Profile
                </button>
                <button class="btn btn-outline-info" onclick="createDefaults()">
                    <i class="bi bi-magic"></i> Create Defaults
                </button>
                <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Active Profile Summary -->
<div class="row mb-4" id="activeProfileSection" style="display: none;">
    <div class="col-md-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> Currently Active Profile
                </h5>
            </div>
            <div class="card-body" id="activeProfileInfo">
                <!-- Active profile info will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Profile List -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list"></i> Configuration Profiles (<span id="profileCount">0</span>)
                    </h5>
                    <div>
                        <select class="form-select form-select-sm" id="websiteFilter" onchange="filterByWebsite()">
                            <option value="">All Websites</option>
                        </select>
                        <input type="text" class="form-control form-control-sm ms-2" id="searchInput" 
                               placeholder="Search profiles..." onkeyup="searchProfiles()" style="width: 200px; display: inline-block;">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="profilesList">
                    <div class="text-center py-5" id="loadingProfiles">
                        <i class="bi bi-hourglass-split"></i> Loading profiles...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalTitle">Create New Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <input type="hidden" id="profileId">
                    
                    <!-- Basic Info -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2">Basic Information</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="profileName" class="form-label">Profile Name *</label>
                                <input type="text" class="form-control" id="profileName" required 
                                       placeholder="e.g., ServiceDogUS Production">
                            </div>
                            
                            <div class="mb-3">
                                <label for="profileDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="profileDescription" rows="2"
                                          placeholder="Optional description"></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="websiteUrl" class="form-label">Website URL *</label>
                                <input type="url" class="form-control" id="websiteUrl" required
                                       placeholder="https://example.com">
                            </div>
                        </div>
                    </div>
                    
                    <!-- WordPress Configuration -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2">WordPress Configuration</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="wpUrl" class="form-label">
                                    WordPress Site URL * 
                                    <span class="badge bg-info">Base URL Only</span>
                                </label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="wpUrl" required
                                           placeholder="https://wp.servicedogus.org">
                                    <button class="btn btn-outline-secondary" type="button" onclick="validateWordPressUrl(document.getElementById('wpUrl').value)">
                                        <i class="bi bi-search"></i> Check API
                                    </button>
                                </div>
                                <div class="form-text">
                                    <div class="alert alert-info py-2 small mb-2">
                                        <i class="bi bi-lightbulb"></i> <strong>What to enter:</strong><br>
                                        ✅ <strong>Correct:</strong> <code>https://wp.servicedogus.org</code><br>
                                        ❌ <strong>Wrong:</strong> <code>https://wp.servicedogus.org/wp-json/wp/v2</code><br>
                                        ❌ <strong>Wrong:</strong> <code>https://wp.servicedogus.org/wp-admin</code><br>
                                        <small class="text-muted">We automatically add /wp-json/wp/v2 for you!</small>
                                    </div>
                                    <small id="wpUrlStatus" class="d-block mt-1">Ready to check API availability</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="wpUsername" class="form-label">
                                    WordPress Username *
                                    <span class="badge bg-secondary">Your WordPress login</span>
                                </label>
                                <input type="text" class="form-control" id="wpUsername" required
                                       placeholder="anthony">
                                <div class="form-text">
                                    <small>Your WordPress admin username (e.g., <code>anthony</code>)</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="wpPassword" class="form-label">
                                    Application Password * 
                                    <span class="badge bg-warning text-dark">Not your login password!</span>
                                </label>
                                <input type="password" class="form-control" id="wpPassword" required 
                                       placeholder="xxxx xxxx xxxx xxxx xxxx xxxx">
                                <div class="form-text">
                                    <div class="alert alert-warning py-2 small mb-2">
                                        <i class="bi bi-key"></i> <strong>How to get your Application Password:</strong><br>
                                        1. Go to WordPress Admin → Users → Your Profile<br>
                                        2. Scroll to "Application Passwords" section<br>
                                        3. Enter name: "Blog Poster" → Click "Add New"<br>
                                        4. Copy the generated password (e.g., <code>1OCk J744 HOey mYvO 5Z3n 9D1c</code>)<br>
                                        <small class="text-muted">✅ Spaces are optional - both formats work!</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="wpAuthMethod" class="form-label">Authentication Method</label>
                                <select class="form-control" id="wpAuthMethod">
                                    <option value="basic">Basic Auth (Local)</option>
                                    <option value="application">Application Password (Production)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="wpVerifySSL" checked>
                                    <label class="form-check-label" for="wpVerifySSL">
                                        Verify SSL Certificate
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-info w-100" onclick="testConnection()">
                                    <i class="bi bi-wifi"></i> Test WordPress Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Settings -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2">Content Generation Settings</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="minWords" class="form-label">Minimum Words</label>
                                <input type="number" class="form-control" id="minWords" value="1500" min="500">
                            </div>
                            
                            <div class="mb-3">
                                <label for="maxWords" class="form-label">Maximum Words</label>
                                <input type="number" class="form-control" id="maxWords" value="2500" min="1000">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxCostPerArticle" class="form-label">Max Cost Per Article</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="maxCostPerArticle" 
                                           value="15.00" step="0.01" min="0.01">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="monthlyBudget" class="form-label">Monthly Budget</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="monthlyBudget" 
                                           value="500.00" step="1.00" min="10">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Agent Configuration -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h6 class="border-bottom pb-2">Agent Configuration</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableCompetitorMonitoring" checked>
                                    <label class="form-check-label" for="enableCompetitorMonitoring">
                                        Competitor Monitoring Agent
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableTopicAnalysis" checked>
                                    <label class="form-check-label" for="enableTopicAnalysis">
                                        Topic Analysis Agent
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableFactChecking" checked>
                                    <label class="form-check-label" for="enableFactChecking">
                                        Legal Fact Checker Agent
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAutoPublish">
                                    <label class="form-check-label" for="enableAutoPublish">
                                        Auto-Publish (Requires Human Approval: Off)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">
                    <i class="bi bi-save"></i> Save Profile
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate Profile Modal -->
<div class="modal fade" id="duplicateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Duplicate Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="duplicateName" class="form-label">New Profile Name</label>
                    <input type="text" class="form-control" id="duplicateName" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmDuplicate()">
                    <i class="bi bi-copy"></i> Duplicate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import/Export Modal -->
<div class="modal fade" id="importExportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import/Export Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Import Profile</h6>
                    <input type="file" class="form-control" id="importFile" accept=".json">
                    <button class="btn btn-outline-success mt-2" onclick="importProfile()">
                        <i class="bi bi-upload"></i> Import
                    </button>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <h6>Export Profile</h6>
                    <p class="text-muted">Select a profile to export:</p>
                    <select class="form-control" id="exportProfileSelect">
                        <option value="">Select profile...</option>
                    </select>
                    <button class="btn btn-outline-primary mt-2" onclick="exportProfile()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentProfiles = [];
let currentEditingId = null;
let currentDuplicatingId = null;
let profileModal = null;
let duplicateModal = null;

// Load profiles on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals once
    profileModal = new bootstrap.Modal(document.getElementById('profileModal'), {
        backdrop: 'static',
        keyboard: false
    });
    
    const duplicateModalEl = document.getElementById('duplicateModal');
    if (duplicateModalEl) {
        duplicateModal = new bootstrap.Modal(duplicateModalEl);
    }
    
    loadProfiles();
    loadActiveProfile();
    loadWebsites();
    
    // Prevent form submission from closing modal
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfile();
    });
    
    // Prevent any clicks inside the modal from bubbling up
    document.getElementById('profileModal').addEventListener('click', function(e) {
        if (e.target.hasAttribute('data-bs-dismiss') && e.target.getAttribute('data-bs-dismiss') === 'modal') {
            // Allow only the close button to dismiss
            return;
        }
        e.stopPropagation();
    });
    
    // Initialize tooltips with proper container to avoid modal conflicts
    setTimeout(() => {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                container: 'body',
                trigger: 'hover focus',
                boundary: 'window'
            })
        });
    }, 500);
});

async function loadProfiles() {
    try {
        const response = await fetch('/api/config/profiles');
        const data = await response.json();
        
        if (data.success) {
            currentProfiles = data.profiles;
            displayProfiles(currentProfiles);
            document.getElementById('profileCount').textContent = data.total;
        } else {
            showError('Failed to load profiles: ' + data.message);
        }
    } catch (error) {
        showError('Error loading profiles: ' + error.message);
    }
}

async function loadActiveProfile() {
    try {
        const response = await fetch('/api/config/profiles/active/current');
        const data = await response.json();
        
        if (data.success && data.profile) {
            document.getElementById('activeProfileSection').style.display = 'block';
            document.getElementById('activeProfileInfo').innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>${data.profile.name}</h6>
                        <p class="mb-1"><strong>Website:</strong> ${data.profile.website_url}</p>
                        <p class="mb-1"><strong>WordPress:</strong> ${data.profile.wordpress.url}</p>
                        <p class="mb-0"><strong>Description:</strong> ${data.profile.description || 'No description'}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editProfile('${data.profile.id}')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="testProfileConnection('${data.profile.id}')">
                            <i class="bi bi-wifi"></i> Test
                        </button>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading active profile:', error);
    }
}

async function loadWebsites() {
    try {
        const response = await fetch('/api/config/websites');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('websiteFilter');
            select.innerHTML = '<option value="">All Websites</option>';
            
            data.websites.forEach(website => {
                const option = document.createElement('option');
                option.value = website;
                option.textContent = website;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading websites:', error);
    }
}

function displayProfiles(profiles) {
    const container = document.getElementById('profilesList');
    
    if (profiles.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-gear fs-1"></i>
                <h4 class="mt-3">No Configuration Profiles</h4>
                <p>Create your first profile to get started.</p>
                <button class="btn btn-primary" onclick="showCreateModal()">
                    <i class="bi bi-plus-circle"></i> Create First Profile
                </button>
            </div>
        `;
        return;
    }
    
    const html = profiles.map(profile => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-1">
                                ${profile.name}
                                ${profile.is_active ? '<span class="badge bg-success ms-2">Active</span>' : ''}
                            </h6>
                        </div>
                        <p class="text-muted mb-1">${profile.description || 'No description'}</p>
                        <div class="small text-muted">
                            <i class="bi bi-globe"></i> ${profile.website_url} |
                            <i class="bi bi-wordpress"></i> ${profile.wordpress.url} |
                            <i class="bi bi-calendar"></i> Updated ${new Date(profile.updated_at).toLocaleDateString()}
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            ${!profile.is_active ? `
                            <button class="btn btn-sm btn-success" onclick="activateProfile('${profile.id}')" title="Set as Active">
                                <i class="bi bi-check-circle"></i>
                            </button>` : ''}
                            
                            <button class="btn btn-sm btn-outline-primary" onclick="editProfile('${profile.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            
                            <button class="btn btn-sm btn-outline-info" onclick="duplicateProfile('${profile.id}')" title="Duplicate">
                                <i class="bi bi-copy"></i>
                            </button>
                            
                            <button class="btn btn-sm btn-outline-secondary" onclick="testProfileConnection('${profile.id}')" title="Test Connection">
                                <i class="bi bi-wifi"></i>
                            </button>
                            
                            ${!profile.is_active ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProfile('${profile.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function filterByWebsite() {
    const websiteUrl = document.getElementById('websiteFilter').value;
    
    if (websiteUrl) {
        const filtered = currentProfiles.filter(p => p.website_url === websiteUrl);
        displayProfiles(filtered);
    } else {
        displayProfiles(currentProfiles);
    }
}

function searchProfiles() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    
    if (query) {
        const filtered = currentProfiles.filter(p => 
            p.name.toLowerCase().includes(query) ||
            p.description.toLowerCase().includes(query) ||
            p.website_url.toLowerCase().includes(query)
        );
        displayProfiles(filtered);
    } else {
        displayProfiles(currentProfiles);
    }
}

function showCreateModal() {
    currentEditingId = null;
    document.getElementById('profileModalTitle').textContent = 'Create New Profile';
    document.getElementById('profileForm').reset();
    document.getElementById('profileId').value = '';
    
    // Set defaults
    document.getElementById('minWords').value = '1500';
    document.getElementById('maxWords').value = '2500';
    document.getElementById('maxCostPerArticle').value = '15.00';
    document.getElementById('monthlyBudget').value = '500.00';
    document.getElementById('wpAuthMethod').value = 'basic';
    document.getElementById('wpVerifySSL').checked = true;
    document.getElementById('enableCompetitorMonitoring').checked = true;
    document.getElementById('enableTopicAnalysis').checked = true;
    document.getElementById('enableFactChecking').checked = true;
    document.getElementById('enableAutoPublish').checked = false;
    
    if (profileModal) {
        profileModal.show();
    } else {
        // Fallback if modal not initialized
        new bootstrap.Modal(document.getElementById('profileModal')).show();
    }
}

async function editProfile(profileId) {
    try {
        const response = await fetch(`/api/config/profiles/${profileId}`);
        const data = await response.json();
        
        if (data.success && data.profile) {
            currentEditingId = profileId;
            const profile = data.profile;
            
            // Fill in all the form fields BEFORE showing the modal
            document.getElementById('profileModalTitle').textContent = 'Edit Profile';
            document.getElementById('profileId').value = profile.id;
            document.getElementById('profileName').value = profile.name;
            document.getElementById('profileDescription').value = profile.description || '';
            document.getElementById('websiteUrl').value = profile.website_url;
            
            // WordPress settings
            document.getElementById('wpUrl').value = profile.wordpress.url;
            document.getElementById('wpUsername').value = profile.wordpress.username;
            document.getElementById('wpPassword').value = profile.wordpress.password;
            document.getElementById('wpAuthMethod').value = profile.wordpress.auth_method;
            document.getElementById('wpVerifySSL').checked = profile.wordpress.verify_ssl;
            
            // Content settings
            document.getElementById('minWords').value = profile.content.min_words;
            document.getElementById('maxWords').value = profile.content.max_words;
            document.getElementById('maxCostPerArticle').value = profile.content.max_cost_per_article;
            document.getElementById('monthlyBudget').value = profile.content.monthly_budget;
            
            // Agent settings
            document.getElementById('enableCompetitorMonitoring').checked = profile.agents.competitor_monitoring;
            document.getElementById('enableTopicAnalysis').checked = profile.agents.topic_analysis;
            document.getElementById('enableFactChecking').checked = profile.agents.fact_checking;
            document.getElementById('enableAutoPublish').checked = profile.agents.auto_publish;
            
            // Show modal with a small delay to ensure DOM is ready
            setTimeout(() => {
                if (profileModal) {
                    profileModal.show();
                } else {
                    // Reinitialize if needed
                    profileModal = new bootstrap.Modal(document.getElementById('profileModal'), {
                        backdrop: 'static',
                        keyboard: false
                    });
                    profileModal.show();
                }
            }, 100);
        } else {
            showError('Failed to load profile for editing');
        }
    } catch (error) {
        showError('Error loading profile: ' + error.message);
    }
}

async function saveProfile() {
    try {
        const formData = {
            name: document.getElementById('profileName').value,
            description: document.getElementById('profileDescription').value,
            website_url: document.getElementById('websiteUrl').value,
            wordpress: {
                url: document.getElementById('wpUrl').value,
                username: document.getElementById('wpUsername').value,
                password: document.getElementById('wpPassword').value,
                auth_method: document.getElementById('wpAuthMethod').value,
                verify_ssl: document.getElementById('wpVerifySSL').checked
            },
            content: {
                min_words: parseInt(document.getElementById('minWords').value),
                max_words: parseInt(document.getElementById('maxWords').value),
                max_cost_per_article: parseFloat(document.getElementById('maxCostPerArticle').value),
                monthly_budget: parseFloat(document.getElementById('monthlyBudget').value)
            },
            agents: {
                competitor_monitoring: document.getElementById('enableCompetitorMonitoring').checked,
                topic_analysis: document.getElementById('enableTopicAnalysis').checked,
                fact_checking: document.getElementById('enableFactChecking').checked,
                auto_publish: document.getElementById('enableAutoPublish').checked
            }
        };
        
        let response;
        if (currentEditingId) {
            response = await fetch(`/api/config/profiles/${currentEditingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
        } else {
            response = await fetch('/api/config/profiles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
        }
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            if (profileModal) {
                profileModal.hide();
            } else {
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            }
            loadProfiles();
            loadActiveProfile();
            loadWebsites();
        } else {
            showError('Failed to save profile: ' + data.message);
        }
    } catch (error) {
        showError('Error saving profile: ' + error.message);
    }
}

async function activateProfile(profileId) {
    const confirmed = await showConfirm(
        'Activate Profile',
        'Set this profile as active? This will deactivate the current active profile.'
    );
    if (confirmed) {
        try {
            const response = await fetch(`/api/config/profiles/${profileId}/activate`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(data.message);
                loadProfiles();
                loadActiveProfile();
            } else {
                showError('Failed to activate profile');
            }
        } catch (error) {
            showError('Error activating profile: ' + error.message);
        }
    }
}

function duplicateProfile(profileId) {
    currentDuplicatingId = profileId;
    const profile = currentProfiles.find(p => p.id === profileId);
    document.getElementById('duplicateName').value = `${profile.name} (Copy)`;
    if (duplicateModal) {
        duplicateModal.show();
    } else {
        new bootstrap.Modal(document.getElementById('duplicateModal')).show();
    }
}

async function confirmDuplicate() {
    const newName = document.getElementById('duplicateName').value;
    
    if (!newName) {
        showError('Please enter a name for the duplicated profile');
        return;
    }
    
    try {
        const response = await fetch(`/api/config/profiles/${currentDuplicatingId}/duplicate?new_name=${encodeURIComponent(newName)}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            if (duplicateModal) {
                duplicateModal.hide();
            } else {
                bootstrap.Modal.getInstance(document.getElementById('duplicateModal')).hide();
            }
            loadProfiles();
            loadWebsites();
        } else {
            showError('Failed to duplicate profile');
        }
    } catch (error) {
        showError('Error duplicating profile: ' + error.message);
    }
}

async function deleteProfile(profileId) {
    const profile = currentProfiles.find(p => p.id === profileId);
    
    const confirmed = await showConfirm(
        'Delete Profile',
        `Delete profile "${profile.name}"? This action cannot be undone.`
    );
    if (confirmed) {
        try {
            const response = await fetch(`/api/config/profiles/${profileId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(data.message);
                loadProfiles();
                loadWebsites();
            } else {
                showError('Failed to delete profile: ' + data.message);
            }
        } catch (error) {
            showError('Error deleting profile: ' + error.message);
        }
    }
}

// Validate WordPress URL and check REST API availability
async function validateWordPressUrl(url) {
    if (!url) return;
    
    const statusEl = document.getElementById('wpUrlStatus');
    statusEl.innerHTML = '<i class="bi bi-hourglass-split"></i> Checking REST API...';
    statusEl.className = 'text-info';
    
    try {
        // Clean the URL - remove trailing slashes and /wp-json if accidentally added
        url = url.replace(/\/+$/, '').replace(/\/wp-json.*$/, '');
        
        // Check if REST API is accessible
        const response = await fetch(`/api/config/check-wp-api?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        
        if (data.success) {
            statusEl.innerHTML = '<i class="bi bi-check-circle text-success"></i> REST API detected at ' + data.api_url;
            statusEl.className = 'text-success';
        } else {
            statusEl.innerHTML = '<i class="bi bi-x-circle text-warning"></i> Could not detect REST API - will try standard endpoint';
            statusEl.className = 'text-warning';
        }
    } catch (error) {
        statusEl.innerHTML = '<i class="bi bi-info-circle"></i> Will attempt standard REST API endpoint';
        statusEl.className = 'text-muted';
    }
}

async function testWordPressConnection(wpUrl, wpUsername, wpPassword, authMethod, verifySSL, buttonSelector = null) {
    // Clean the URL - remove trailing slashes and /wp-json if accidentally added
    wpUrl = wpUrl.replace(/\/+$/, '').replace(/\/wp-json.*$/, '');
    
    // Clean the password - WordPress accepts with or without spaces
    // Remove any spaces user might have copy-pasted
    wpPassword = wpPassword.replace(/\s/g, '');
    
    // Get the button reference if provided
    let button = null;
    let originalText = '';
    if (buttonSelector) {
        button = document.querySelector(buttonSelector);
        if (button) {
            originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';
            button.disabled = true;
        }
    }
    
    try {
        const response = await fetch('/api/config/test-wp-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                wp_url: wpUrl,
                username: wpUsername,
                password: wpPassword,
                auth_method: authMethod,
                verify_ssl: verifySSL
            })
        });
        
        // Check if response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        let data;
        try {
            data = await response.json();
        } catch (parseError) {
            console.error('Failed to parse response:', parseError);
            throw new Error('Invalid response from server');
        }
        
        if (data.success) {
            showSuccess('WordPress connection test successful!');
            return true;
        } else {
            const errorMsg = data.error || data.message || 'Connection failed';
            showError('Connection test failed: ' + errorMsg);
            console.error('Connection test failed:', data);
            return false;
        }
    } catch (error) {
        console.error('Connection test error:', error);
        showError('Connection test error: ' + (error.message || 'Unknown error'));
        return false;
    } finally {
        // Reset button state
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
}

async function testConnection() {
    // Get form values
    let wpUrl = document.getElementById('wpUrl').value.trim();
    const wpUsername = document.getElementById('wpUsername').value.trim();
    let wpPassword = document.getElementById('wpPassword').value.trim();
    const authMethod = document.getElementById('wpAuthMethod').value;
    const verifySSL = document.getElementById('wpVerifySSL').checked;
    
    // Validate required fields
    if (!wpUrl || !wpUsername || !wpPassword) {
        showError('Please fill in all required WordPress fields before testing');
        return;
    }
    
    await testWordPressConnection(wpUrl, wpUsername, wpPassword, authMethod, verifySSL, 'button[onclick="testConnection()"]');
}

async function testProfileConnection(profileId) {
    try {
        // Get profile data first
        const profileResponse = await fetch(`/api/config/profiles/${profileId}`);
        const profileData = await profileResponse.json();
        
        if (!profileData.success) {
            showError('Failed to load profile data');
            return;
        }
        
        const profile = profileData.profile;
        
        // Use the shared connection test function
        await testWordPressConnection(
            profile.wordpress.url,
            profile.wordpress.username,
            profile.wordpress.password,
            profile.wordpress.auth_method,
            profile.wordpress.verify_ssl,
            `button[onclick="testProfileConnection('${profileId}')"]`
        );
    } catch (error) {
        showError('Connection test error: ' + error.message);
    }
}

async function createDefaults() {
    try {
        const response = await fetch('/api/config/profiles/defaults', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            loadProfiles();
            loadWebsites();
        } else {
            showError('Failed to create default profiles');
        }
    } catch (error) {
        showError('Error creating defaults: ' + error.message);
    }
}

// Toast notification functions
function showSuccess(message) {
    showToast(message, 'success', 'bi-check-circle-fill');
}

function showError(message) {
    showToast(message, 'danger', 'bi-x-circle-fill');
}

function showToast(message, type = 'info', icon = 'bi-info-circle') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="${icon} me-2"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast to container
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    toastContainer.appendChild(toastElement.firstElementChild);
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastContainer.lastElementChild);
    toast.show();
    
    // Remove after hidden
    toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Confirmation dialog function
async function showConfirm(title, message) {
    return confirm(`${title}\n\n${message}`);
}
</script>
{% endblock %}