{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-file-text"></i> Article Management</h2>
            <div>
                <button class="btn btn-primary" onclick="generateArticle()">
                    <i class="bi bi-file-plus"></i> Generate New Article
                </button>
                <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Article Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-primary">{{ total_articles }}</div>
                <div class="metric-label">Total Articles</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-success">
                    {{ articles|selectattr("published", "equalto", true)|list|length }}
                </div>
                <div class="metric-label">Published</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-warning">
                    {{ articles|selectattr("published", "equalto", false)|list|length }}
                </div>
                <div class="metric-label">Drafts</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-info">
                    {% set total_words = articles|selectattr("word_count", "defined")|map(attribute="word_count")|sum %}
                    {{ "{:,}".format(total_words or 0) }}
                </div>
                <div class="metric-label">Total Words</div>
            </div>
        </div>
    </div>
</div>

<!-- Articles List -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list"></i> Recent Articles ({{ articles|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if articles %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Word Count</th>
                                <th>SEO Score</th>
                                <th>Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for article in articles %}
                            <tr>
                                <td>
                                    <strong>{{ article.title or 'Untitled' }}</strong>
                                    {% if article.primary_keyword %}
                                    <div class="small text-muted">
                                        <i class="bi bi-key"></i> {{ article.primary_keyword }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if article.published %}
                                        <span class="status-badge status-healthy">Published</span>
                                    {% elif article.wordpress_post_id %}
                                        <span class="status-badge status-warning">Draft</span>
                                    {% else %}
                                        <span class="status-badge status-error">Local Only</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ article.created_at.strftime('%Y-%m-%d %H:%M') if article.created_at else 'Unknown' }}
                                    <div class="small text-muted">
                                        {{ article.created_at.strftime('%A') if article.created_at else '' }}
                                    </div>
                                </td>
                                <td>
                                    {% if article.get('word_count') %}
                                        {{ "{:,}".format(article.word_count) }}
                                        <div class="small text-muted">
                                            {% if article.word_count >= 1500 %}
                                                <span class="text-success">Excellent</span>
                                            {% elif article.word_count >= 1000 %}
                                                <span class="text-warning">Good</span>
                                            {% else %}
                                                <span class="text-danger">Short</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if article.seo_score %}
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar 
                                                {% if article.seo_score >= 80 %}bg-success
                                                {% elif article.seo_score >= 60 %}bg-warning
                                                {% else %}bg-danger{% endif %}"
                                                 style="width: {{ article.seo_score }}%;">
                                            </div>
                                        </div>
                                        <div class="small text-center">{{ article.seo_score }}/100</div>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if article.generation_cost %}
                                        ${{ "%.4f"|format(article.generation_cost) }}
                                        <div class="small text-muted">
                                            {% if article.generation_cost < 0.05 %}
                                                <span class="text-success">Low</span>
                                            {% elif article.generation_cost < 0.15 %}
                                                <span class="text-warning">Normal</span>
                                            {% else %}
                                                <span class="text-danger">High</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="/articles/{{ article.file_path.split('/')[-1].replace('.json', '') }}" 
                                           class="btn btn-outline-primary btn-sm"
                                           title="View Article">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        
                                        {% if article.wordpress_post_id %}
                                        <a href="{{ article.wordpress_url }}" 
                                           target="_blank"
                                           class="btn btn-outline-success btn-sm"
                                           title="View on WordPress">
                                            <i class="bi bi-wordpress"></i>
                                        </a>
                                        {% else %}
                                        <button class="btn btn-outline-info btn-sm"
                                                onclick="publishToWordPress('{{ article.file_path }}')"
                                                title="Publish to WordPress">
                                            <i class="bi bi-upload"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-outline-warning btn-sm"
                                                onclick="editArticle('{{ article.file_path }}')"
                                                title="Edit Article">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        
                                        <button class="btn btn-outline-danger btn-sm"
                                                onclick="deleteArticle('{{ article.file_path }}')"
                                                title="Delete Article">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-file-text fs-1"></i>
                    <h4 class="mt-3">No Articles Yet</h4>
                    <p>Generate your first article to get started.</p>
                    <button class="btn btn-primary" onclick="generateArticle()">
                        <i class="bi bi-file-plus"></i> Generate First Article
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Article Preview Modal -->
<div class="modal fade" id="articlePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Article Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="articlePreviewContent" style="max-height: 70vh; overflow-y: auto;">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="publishArticleBtn">
                    <i class="bi bi-upload"></i> Publish to WordPress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Article Editor Modal -->
<div class="modal fade" id="articleEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="articleEditForm">
                    <div class="mb-3">
                        <label for="articleTitle" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="articleTitle" 
                               data-validate='{"required": true, "minLength": 10, "maxLength": 60}'
                               placeholder="Enter a compelling title (10-60 characters)">
                    </div>
                    
                    <div class="mb-3">
                        <label for="articleKeyword" class="form-label">Primary Keyword <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="articleKeyword"
                               data-validate='{"required": true, "minLength": 3, "maxLength": 50}'
                               placeholder="Main keyword for SEO">
                    </div>
                    
                    <div class="mb-3">
                        <label for="articleMeta" class="form-label">Meta Description</label>
                        <textarea class="form-control" id="articleMeta" rows="2"
                                  data-validate='{"maxLength": 155}'
                                  placeholder="Brief description for search engines (max 155 characters)"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="articleContent" class="form-label">Content</label>
                        <textarea class="form-control" id="articleContent" rows="15"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveArticle()">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentArticlePath = '';

async function viewArticle(filePath) {
    try {
        const response = await fetch(`/api/article/content?path=${encodeURIComponent(filePath)}`);
        const article = await response.json();
        
        document.getElementById('articlePreviewContent').innerHTML = `
            <div class="mb-3">
                <h3>${article.title || 'Untitled'}</h3>
                <p class="text-muted">${article.meta_description || 'No meta description'}</p>
                <div class="mb-2">
                    <span class="badge bg-primary">${article.primary_keyword || 'No keyword'}</span>
                    <span class="badge bg-info">${article.word_count || 0} words</span>
                    ${article.seo_score ? `<span class="badge bg-success">SEO: ${article.seo_score}/100</span>` : ''}
                </div>
            </div>
            <div class="article-content">
                ${article.content || 'No content available'}
            </div>
        `;
        
        currentArticlePath = filePath;
        document.getElementById('publishArticleBtn').onclick = () => publishToWordPress(filePath);
        
        new bootstrap.Modal(document.getElementById('articlePreviewModal')).show();
    } catch (error) {
        showError('Failed to load article: ' + error.message);
    }
}

async function editArticle(filePath) {
    try {
        const response = await fetch(`/api/article/content?path=${encodeURIComponent(filePath)}`);
        const article = await response.json();
        
        document.getElementById('articleTitle').value = article.title || '';
        document.getElementById('articleKeyword').value = article.primary_keyword || '';
        document.getElementById('articleMeta').value = article.meta_description || '';
        document.getElementById('articleContent').value = article.content || '';
        
        updateMetaCount();
        currentArticlePath = filePath;
        
        new bootstrap.Modal(document.getElementById('articleEditorModal')).show();
    } catch (error) {
        showError('Failed to load article for editing: ' + error.message);
    }
}

async function saveArticle() {
    // Validate form first
    const form = document.getElementById('articleEditForm');
    if (!FormValidator.validateForm(form)) {
        showWarning('Please fix the validation errors before saving');
        return;
    }
    
    const updatedArticle = {
        title: document.getElementById('articleTitle').value,
        primary_keyword: document.getElementById('articleKeyword').value,
        meta_description: document.getElementById('articleMeta').value,
        content: document.getElementById('articleContent').value
    };
    
    showLoading();
    try {
        const response = await fetch(`/api/article/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                file_path: currentArticlePath,
                ...updatedArticle
            })
        });
        
        hideLoading();
        if (response.ok) {
            showSuccess('Article updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('articleEditorModal')).hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError('Failed to update article');
        }
    } catch (error) {
        hideLoading();
        showError('Error updating article: ' + error.message);
    }
}

async function publishToWordPress(filePath) {
    const confirmed = await showConfirm('Publish Article', 'Publish this article to WordPress?');
    if (confirmed) {
        try {
            const response = await fetch('/api/article/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: filePath })
            });
            
            const result = await response.json();
            if (response.ok) {
                showSuccess(`Article published successfully! Post ID: ${result.post_id}`);
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showError('Failed to publish: ' + result.detail);
            }
        } catch (error) {
            showError('Publishing failed: ' + error.message);
        }
    }
}

async function deleteArticle(filePath) {
    const confirmed = await showConfirm('Delete Article', 'Delete this article? This action cannot be undone.');
    if (confirmed) {
        try {
            const response = await fetch(`/api/article/delete`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: filePath })
            });
            
            if (response.ok) {
                showSuccess('Article deleted successfully!');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showError('Failed to delete article');
            }
        } catch (error) {
            showError('Error deleting article: ' + error.message);
        }
    }
}

// Form validation is now handled by the FormValidator class in base.html
// Character counting and validation happens automatically for fields with data-validate attributes
</script>
{% endblock %}