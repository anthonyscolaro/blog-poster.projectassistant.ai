{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-diagram-3"></i> Pipeline Monitor</h2>
            <div>
                <button class="btn btn-primary" onclick="runPipeline()">
                    <i class="bi bi-play-circle"></i> Run Pipeline
                </button>
                <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Active Pipelines -->
{% if active_pipelines %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle-fill"></i> Active Pipelines ({{ active_pipelines|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for pipeline in active_pipelines %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Pipeline ID: {{ pipeline.pipeline_id }}</h6>
                                <p class="text-muted">Started: {{ pipeline.started_at }} | Keyword: {{ pipeline.primary_keyword }}</p>
                                
                                <!-- Progress Steps -->
                                <div class="pipeline-steps">
                                    {% for step in pipeline.steps %}
                                    <div class="pipeline-step step-{{ step.status }}">
                                        <strong>{{ step.name }}</strong>
                                        <div class="small">
                                            Status: {{ step.status }} 
                                            {% if step.duration %}| Duration: {{ step.duration }}s{% endif %}
                                            {% if step.cost %}| Cost: ${{ "%.4f"|format(step.cost) }}{% endif %}
                                        </div>
                                        {% if step.error %}
                                        <div class="small text-danger">Error: {{ step.error }}</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ pipeline.progress }}%;" 
                                         aria-valuenow="{{ pipeline.progress }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div><strong>{{ pipeline.progress }}% Complete</strong></div>
                                <div class="small text-muted">ETA: {{ pipeline.eta or 'Calculating...' }}</div>
                                
                                {% if pipeline.status == 'running' %}
                                <button class="btn btn-danger btn-sm mt-2" onclick="stopPipeline('{{ pipeline.pipeline_id }}')">
                                    <i class="bi bi-stop-circle"></i> Stop
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Pipeline History -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Pipeline History (Last 20 Runs)
                </h5>
            </div>
            <div class="card-body">
                {% if pipeline_history %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Pipeline ID</th>
                                <th>Keyword</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Cost</th>
                                <th>Article</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for run in pipeline_history %}
                            <tr>
                                <td>
                                    <code>{{ run.pipeline_id[:8] }}...</code>
                                </td>
                                <td>
                                    <strong>{{ run.primary_keyword or 'Auto-generated' }}</strong>
                                </td>
                                <td>
                                    {{ run.started_at }}
                                    <div class="small text-muted">{{ run.time_ago }}</div>
                                </td>
                                <td>
                                    {% if run.duration %}
                                        {{ run.duration }}s
                                        <div class="small text-muted">
                                            {% if run.duration < 30 %}
                                                <span class="text-success">Fast</span>
                                            {% elif run.duration < 60 %}
                                                <span class="text-warning">Normal</span>
                                            {% else %}
                                                <span class="text-danger">Slow</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if run.status == 'completed' %}
                                        <span class="status-badge status-healthy">Completed</span>
                                    {% elif run.status == 'failed' %}
                                        <span class="status-badge status-error">Failed</span>
                                    {% elif run.status == 'running' %}
                                        <span class="status-badge status-warning">Running</span>
                                    {% else %}
                                        <span class="status-badge status-warning">{{ run.status|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if run.cost %}
                                        ${{ "%.4f"|format(run.cost) }}
                                        <div class="small text-muted">
                                            {% if run.cost < 0.05 %}
                                                <span class="text-success">Low</span>
                                            {% elif run.cost < 0.15 %}
                                                <span class="text-warning">Normal</span>
                                            {% else %}
                                                <span class="text-danger">High</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if run.article_generated %}
                                        <a href="/articles/{{ run.article_id }}" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-file-text"></i> View
                                        </a>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                onclick="viewPipelineDetails('{{ run.pipeline_id }}')"
                                                title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        {% if run.status == 'failed' %}
                                        <button class="btn btn-outline-warning btn-sm"
                                                onclick="retryPipeline('{{ run.pipeline_id }}')"
                                                title="Retry">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-danger btn-sm"
                                                onclick="deletePipeline('{{ run.pipeline_id }}')"
                                                title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-diagram-3 fs-1"></i>
                    <h4 class="mt-3">No Pipeline Runs Yet</h4>
                    <p>Start your first pipeline to see the results here.</p>
                    <button class="btn btn-primary" onclick="runPipeline()">
                        <i class="bi bi-play-circle"></i> Run First Pipeline
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Pipeline Stats -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-primary">{{ pipeline_history|length }}</div>
                <div class="metric-label">Total Runs</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-success">
                    {{ pipeline_history|selectattr("status", "equalto", "completed")|list|length }}
                </div>
                <div class="metric-label">Successful</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-danger">
                    {{ pipeline_history|selectattr("status", "equalto", "failed")|list|length }}
                </div>
                <div class="metric-label">Failed</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value text-info">
                    {% set avg_duration = pipeline_history|selectattr("duration")|map(attribute="duration")|list %}
                    {% if avg_duration %}
                        {{ "%.1f"|format(avg_duration|sum / avg_duration|length) }}s
                    {% else %}
                        0s
                    {% endif %}
                </div>
                <div class="metric-label">Avg Duration</div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Log Viewer -->
<div class="row mt-4" id="logViewerSection" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-terminal"></i> Real-time Pipeline Logs
                        <span id="logPipelineId" class="text-info"></span>
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleAutoScroll()">
                            <i class="bi bi-arrow-down-circle" id="autoScrollIcon"></i> Auto-scroll
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="closeLogs()">
                            <i class="bi bi-x-circle"></i> Close
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body bg-dark text-light" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace;" id="logContainer">
                <div id="logContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Pipeline Details -->
<div class="modal fade" id="pipelineDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pipeline Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pipelineDetailsContent">
                Loading...
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Pipeline Configuration -->
<div class="modal fade" id="pipelineConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-gear-fill"></i> Configure Pipeline Run
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pipelineConfigForm">
                    <div class="mb-3">
                        <label for="pipelineTopic" class="form-label">Topic</label>
                        <input type="text" class="form-control" id="pipelineTopic" 
                               placeholder="Leave empty for auto-selection">
                        <div class="form-text">Optional: Specify a topic or let the system auto-select</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="pipelineKeyword" class="form-label">Primary Keyword <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="pipelineKeyword" 
                               placeholder="e.g., service dog training" required>
                        <div class="form-text">Required: Main keyword to optimize content for</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useCompetitorInsights" checked>
                            <label class="form-check-label" for="useCompetitorInsights">
                                <i class="bi bi-graph-up"></i> Use Competitor Insights
                            </label>
                        </div>
                        <div class="form-text">Analyze competitor content for better positioning</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="performFactChecking" checked>
                            <label class="form-check-label" for="performFactChecking">
                                <i class="bi bi-shield-check"></i> Perform Fact Checking
                            </label>
                        </div>
                        <div class="form-text">Verify legal claims and ADA compliance</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoPublish">
                            <label class="form-check-label" for="autoPublish">
                                <i class="bi bi-wordpress"></i> Auto-publish to WordPress
                            </label>
                        </div>
                        <div class="form-text">Automatically publish when generation is complete</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="startPipelineWithConfig()">
                    <i class="bi bi-play-circle-fill"></i> Start Pipeline
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// WebSocket connection for real-time logs
let logWebSocket = null;
let currentPipelineId = null;
let autoScroll = true;

function connectToLogs(pipelineId) {
    // Close existing connection if any
    if (logWebSocket) {
        logWebSocket.close();
    }
    
    currentPipelineId = pipelineId;
    document.getElementById('logPipelineId').textContent = `(${pipelineId.substring(0, 8)}...)`;
    document.getElementById('logViewerSection').style.display = 'block';
    document.getElementById('logContent').innerHTML = '';
    
    // Connect to WebSocket
    const wsUrl = `ws://localhost:8088/ws/logs/${pipelineId}`;
    logWebSocket = new WebSocket(wsUrl);
    
    logWebSocket.onopen = function(event) {
        addLogEntry('info', 'Connected to pipeline logs...', 'SYSTEM');
    };
    
    logWebSocket.onmessage = function(event) {
        // Skip heartbeat pongs
        if (event.data === 'pong') {
            return;
        }
        
        try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'initial' && data.logs) {
                // Display initial logs
                data.logs.forEach(log => {
                    addLogEntry(log.level, log.message, log.agent, log.data, log.timestamp);
                });
            } else {
                // Single log entry
                addLogEntry(data.level, data.message, data.agent, data.data, data.timestamp);
            }
        } catch (e) {
            console.error('Error parsing WebSocket message:', e, event.data);
        }
    };
    
    logWebSocket.onerror = function(error) {
        addLogEntry('error', 'WebSocket error: ' + error, 'SYSTEM');
    };
    
    logWebSocket.onclose = function(event) {
        addLogEntry('warning', 'Disconnected from pipeline logs', 'SYSTEM');
    };
    
    // Send heartbeat to keep connection alive
    setInterval(() => {
        if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
            logWebSocket.send('ping');
        }
    }, 30000);
}

function addLogEntry(level, message, agent, data, timestamp) {
    const logContent = document.getElementById('logContent');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry mb-1';
    
    // Color coding based on level
    let levelColor = '#888';
    let levelIcon = '‚óè';
    switch(level) {
        case 'error': levelColor = '#ff6b6b'; levelIcon = '‚úó'; break;
        case 'warning': levelColor = '#ffd93d'; levelIcon = '‚ö†'; break;
        case 'success': levelColor = '#6bcf7f'; levelIcon = '‚úì'; break;
        case 'info': levelColor = '#4dabf7'; levelIcon = '‚Ñπ'; break;
        case 'metric': levelColor = '#ff6ec7'; levelIcon = 'üìä'; break;
        case 'debug': levelColor = '#868e96'; levelIcon = 'üîç'; break;
    }
    
    // Format timestamp
    const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
    
    // Build log HTML
    let html = `
        <span style="color: ${levelColor}">${levelIcon}</span>
        <span style="color: #aaa">[${time}]</span>
        <span style="color: #ffd93d">[${agent || 'SYSTEM'}]</span>
        <span style="color: #fff">${message}</span>
    `;
    
    // Add data if present
    if (data && Object.keys(data).length > 0) {
        html += `<div style="margin-left: 40px; color: #888; font-size: 0.9em;">`;
        for (const [key, value] of Object.entries(data)) {
            if (key === 'competitors' || key === 'keywords' || key === 'trending_topics' || key === 'content_gaps') {
                // Special formatting for arrays
                if (Array.isArray(value)) {
                    html += `<div>${key}: ${value.map(v => typeof v === 'object' ? JSON.stringify(v) : v).join(', ')}</div>`;
                } else {
                    html += `<div>${key}: ${JSON.stringify(value)}</div>`;
                }
            } else {
                html += `<div>${key}: ${value}</div>`;
            }
        }
        html += `</div>`;
    }
    
    logEntry.innerHTML = html;
    logContent.appendChild(logEntry);
    
    // Auto-scroll if enabled
    if (autoScroll) {
        const logContainer = document.getElementById('logContainer');
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

function clearLogs() {
    document.getElementById('logContent').innerHTML = '';
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    const icon = document.getElementById('autoScrollIcon');
    icon.className = autoScroll ? 'bi bi-arrow-down-circle-fill' : 'bi bi-arrow-down-circle';
}

function closeLogs() {
    if (logWebSocket) {
        logWebSocket.close();
        logWebSocket = null;
    }
    document.getElementById('logViewerSection').style.display = 'none';
}

function runPipeline() {
    // Reset form
    document.getElementById('pipelineConfigForm').reset();
    
    // Show the configuration modal
    const modal = new bootstrap.Modal(document.getElementById('pipelineConfigModal'));
    modal.show();
}

async function startPipelineWithConfig() {
    // Get form values
    const topic = document.getElementById('pipelineTopic').value.trim();
    const primaryKeyword = document.getElementById('pipelineKeyword').value.trim();
    const useCompetitorInsights = document.getElementById('useCompetitorInsights').checked;
    const performFactChecking = document.getElementById('performFactChecking').checked;
    const autoPublish = document.getElementById('autoPublish').checked;
    
    // Validate required fields
    if (!primaryKeyword) {
        // Show validation error
        document.getElementById('pipelineKeyword').classList.add('is-invalid');
        return;
    }
    
    // Hide the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('pipelineConfigModal'));
    modal.hide();
    
    // Show loading indicator
    showLoadingToast('Starting pipeline...');
    
    const config = {
        topic: topic || null,
        primary_keyword: primaryKeyword,
        use_competitor_insights: useCompetitorInsights,
        perform_fact_checking: performFactChecking,
        auto_publish: autoPublish
    };
    
    try {
        const response = await fetch('/pipeline/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Connect to logs for this pipeline
            if (result.pipeline_id) {
                connectToLogs(result.pipeline_id);
            }
            
            showSuccessToast('Pipeline started successfully!');
            setTimeout(() => window.location.reload(), 2000);
        } else {
            const error = await response.text();
            showErrorToast('Failed to start pipeline: ' + error);
        }
    } catch (error) {
        showErrorToast('Error: ' + error.message);
    }
}

// Confirmation dialog function
function showConfirmDialog(title, message) {
    return new Promise((resolve) => {
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').textContent = message;
        
        const confirmBtn = document.getElementById('confirmModalBtn');
        const handleConfirm = () => {
            modal.hide();
            confirmBtn.removeEventListener('click', handleConfirm);
            resolve(true);
        };
        
        confirmBtn.addEventListener('click', handleConfirm);
        
        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function handler() {
            confirmBtn.removeEventListener('click', handleConfirm);
            document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', handler);
            resolve(false);
        });
        
        modal.show();
    });
}

// Toast notification functions
function showLoadingToast(message) {
    showToast(message, 'info', 'spinner-border spinner-border-sm');
}

function showSuccessToast(message) {
    showToast(message, 'success', 'bi-check-circle-fill');
}

function showErrorToast(message) {
    showToast(message, 'danger', 'bi-x-circle-fill');
}

function showToast(message, type = 'info', icon = 'bi-info-circle') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="${icon} me-2"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast to container
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    toastContainer.appendChild(toastElement.firstElementChild);
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastContainer.lastElementChild);
    toast.show();
    
    // Remove after hidden
    toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

async function stopPipeline(pipelineId) {
    if (await showConfirmDialog('Stop Pipeline', 'Are you sure you want to stop this pipeline?')) {
        try {
            const response = await fetch(`/pipeline/${pipelineId}/stop`, { method: 'POST' });
            if (response.ok) {
                showSuccessToast('Pipeline stopped successfully');
                window.location.reload();
            } else {
                showErrorToast('Failed to stop pipeline');
            }
        } catch (error) {
            showErrorToast('Error: ' + error.message);
        }
    }
}

async function retryPipeline(pipelineId) {
    if (await showConfirmDialog('Retry Pipeline', 'Are you sure you want to retry this pipeline?')) {
        try {
            const response = await fetch(`/pipeline/${pipelineId}/retry`, { method: 'POST' });
            if (response.ok) {
                showSuccessToast('Pipeline restarted successfully');
                window.location.reload();
            } else {
                showErrorToast('Failed to retry pipeline');
            }
        } catch (error) {
            showErrorToast('Error: ' + error.message);
        }
    }
}

async function deletePipeline(pipelineId) {
    if (await showConfirmDialog('Delete Pipeline', 'Are you sure you want to delete this pipeline run? This action cannot be undone.')) {
        try {
            const response = await fetch(`/pipeline/${pipelineId}`, { method: 'DELETE' });
            if (response.ok) {
                showSuccessToast('Pipeline deleted successfully');
                window.location.reload();
            } else {
                showErrorToast('Failed to delete pipeline');
            }
        } catch (error) {
            showErrorToast('Error: ' + error.message);
        }
    }
}

async function viewPipelineDetails(pipelineId) {
    // Show log viewer instead of modal
    connectToLogs(pipelineId);
    
    // Also fetch historical logs
    try {
        const response = await fetch(`/logs/${pipelineId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.logs) {
                document.getElementById('logContent').innerHTML = '';
                data.logs.forEach(log => {
                    addLogEntry(log.level, log.message, log.agent, log.data, log.timestamp);
                });
            }
        }
    } catch (error) {
        console.error('Failed to load historical logs:', error);
    }
}

// Auto-refresh every 10 seconds for active pipelines
setInterval(() => {
    const activeCount = {{ active_pipelines|length if active_pipelines else 0 }};
    if (activeCount > 0 && !logWebSocket) {
        window.location.reload();
    }
}, 10000);

// Connect to logs for any active pipeline on page load
{% if active_pipelines %}
    {% for pipeline in active_pipelines %}
        {% if loop.first %}
            // Auto-connect to first active pipeline
            setTimeout(() => connectToLogs('{{ pipeline.pipeline_id }}'), 1000);
        {% endif %}
    {% endfor %}
{% endif %}
</script>
{% endblock %}